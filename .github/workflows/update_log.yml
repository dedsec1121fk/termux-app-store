name: Auto Update Packages Changelog

on:
  push:
    branches: [ master ]

jobs:
  changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.TERMUXAPPSTORE }}

      - name: Detect package changes and update changelog
        run: |
          set -e

          CHANGELOG="CHANGELOG.md"

          # create changelog if it doesn't exist
          if [[ ! -f "$CHANGELOG" ]]; then
            cat <<EOF > "$CHANGELOG"
# Changelog

## [Unreleased]
### Added
### Updated
### Fixed
EOF
          fi

          # detect changed build.sh
          git diff --name-only HEAD~1 HEAD \
            | grep '^packages/.*/build.sh' > /tmp/changed || true

          [[ -s /tmp/changed ]] || exit 0

          while read -r build; do
            pkg=$(basename "$(dirname "$build")")
            ver=$(grep '^TERMUX_PKG_VERSION=' "$build" | head -n1 | cut -d= -f2)

            # decide section: Added or Updated
            if grep -q "Package \`${pkg}\`" "$CHANGELOG"; then
              section="Updated"
            else
              section="Added"
            fi

            # append only if version entry doesn't exist
            if ! awk '/## \[Unreleased\]/,/^## \[/' "$CHANGELOG" \
              | grep -q "\`${pkg}\` v${ver}"; then
              sed -i "/### ${section}/a - Package \`${pkg}\` v${ver}" "$CHANGELOG"
            fi
          done < /tmp/changed

      - name: Commit & push
        run: |
          git config user.name "Termux App Store"
          git config user.email "258516621+termux-app-store@users.noreply.github.com"

          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "changelog: update packages [ci skip]"
            git push origin master --force-with-lease
          fi
